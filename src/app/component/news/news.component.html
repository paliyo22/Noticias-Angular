@let newsObject = newsService.state().singleNews;
@let userObject = userService.userState();
@let authObject = authService.authState();

<main class="news-detail">
  <div class="container">
    @if (newsObject.loading) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Cargando noticia...</p>
      </div>
    } @else if (newsObject.error) {
      <div class="error-state">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h2>Error al cargar la noticia</h2>
        <p>{{ newsObject.error }}</p>
        <button class="btn btn-primary" (click)="retry()">
          Reintentar
        </button>
      </div>
    } @else if (newsObject.data) {
      @let news = newsObject.data;
      
      <!-- Breadcrumb -->
      <nav class="breadcrumb" aria-label="Navegaci√≥n">
        <a routerLink="/">Inicio</a>
        <span class="separator">‚Ä∫</span>
        @if (news.category) {
          <a [routerLink]="['/category', news.category.toLowerCase()]">
            {{ getCategory(news.category) }}
          </a>
          <span class="separator">‚Ä∫</span>
        }
        <span class="current">{{ news.title }}</span>
      </nav>

      <!-- Art√≠culo principal -->
      <article class="article">
        <header class="article-header">
          <div class="article-meta-top">
            @if (news.category) {
              <a class="category-tag" [routerLink]="['/category', news.category.toLowerCase()]">
                {{ getCategory(news.category) }}
              </a>
            }
            <time class="publish-date" [dateTime]="news.timestamp">
              {{ news.timestamp | date: 'dd MMMM yyyy, HH:mm' }}
            </time>
          </div>
          
          <h1 class="article-title">{{ news.title }}</h1>
          
          <div class="article-meta-bottom">
            <div class="publisher-info">
              <span class="publisher-label">Publicado por</span>
              <span class="publisher-name">{{ news.publisher }}</span>
            </div>
            
            <div class="article-actions">
              @if (authObject.logged) {
                <button 
                  class="like-btn"
                  [class.liked]="userObject.result.state"
                  (click)="toggleLike()"
                  [disabled]="userObject.user.loading"
                  aria-label="Me gusta">
                  <span class="like-icon">{{ userObject.result.state ? '‚ù§Ô∏è' : 'ü§ç' }}</span>
                  <span class="like-text">{{ userObject.result.state ? 'Te gusta' : 'Me gusta' }}</span>
                  @if (userObject.result.state !== undefined) {
                    <span class="like-count">{{ newsObject.data.likes }}</span>
                  }
                </button>
              } @else {
                <div class="login-prompt">
                  <span class="login-text">
                    <a routerLink="/login" class="login-link">Inicia sesi√≥n</a> 
                    para dar me gusta
                  </span>
                </div>
              }
              
              <button 
                class="share-btn" 
                (click)="shareArticle()" 
                type="button"
                aria-label="Compartir art√≠culo">
                <span class="share-icon">üì§</span>
                <span class="share-text">Compartir</span>
              </button>
            </div>
          </div>
        </header>

        <figure class="article-image">
          <img 
            [src]="news.image_url || '/image.png'" 
            [alt]="news.title"
            loading="lazy">
        </figure>

        <div class="article-content">
          <div class="article-snippet">
            <p>{{ news.snippet }}</p>
          </div>
          
          @if (news.newsUrl) {
            <div class="read-more-section">
              <button 
                class="btn-read-more" 
                type="button"
                (click)="openNewsUrl($event, news.newsUrl)"
                aria-label="Leer art√≠culo completo en fuente original">
                <span class="btn-text">Ver m√°s</span>
                <span class="btn-icon">‚Üí</span>
              </button>
              <p class="source-note">
                Contin√∫a leyendo en <strong>{{ news.publisher }}</strong>
              </p>
            </div>
          }
        </div>
      </article>

      <!-- Componente de comentarios -->
      <app-comment [newsId]="news.id"></app-comment>

      <!-- Noticias relacionadas o destacadas -->
      @if (newsObject.subData && newsObject.subData.length > 0) {
        <section class="related-news">
          <h2 class="section-title">Noticias relacionadas</h2>
          <div class="related-grid">
            @for (relatedNews of newsObject.subData; track relatedNews.id) {
              <article class="related-card">
                <a [routerLink]="['/news', relatedNews.id]" class="card-link">
                  <div class="card-image">
                    <img 
                      [src]="relatedNews.image_url || '/image.png'" 
                      [alt]="relatedNews.title"
                      loading="lazy">
                  </div>
                  <div class="card-content">
                    @if (relatedNews.category) {
                      <span class="card-category">{{ getCategory(relatedNews.category) }}</span>
                    }
                    <h3 class="card-title">{{ relatedNews.title }}</h3>
                    <p class="card-excerpt">{{ relatedNews.snippet }}</p>
                    <div class="card-meta">
                      <time [dateTime]="relatedNews.timestamp">
                        {{ relatedNews.timestamp | date: 'dd/MM/yyyy' }}
                      </time>
                      <span class="card-publisher">{{ relatedNews.publisher }}</span>
                    </div>
                  </div>
                </a>
              </article>
            }
          </div>
        </section>
      } @else {
        <!-- Si no hay noticias relacionadas, mostrar noticias destacadas -->
        <section class="featured-fallback">
          <h2 class="section-title">Noticias destacadas</h2>
          <app-featured-news/>
        </section>
      }
    } @else {
      <div class="empty-state">
        <div class="empty-icon">üì∞</div>
        <h2>Noticia no encontrada</h2>
        <p>La noticia que buscas no existe o ha sido eliminada.</p>
      </div>
    }
  </div>
</main>
